<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Releases</title>
<link rel="stylesheet" href="dashboard.css">
</head>
<body>

<div class="navbar">
  <div class="brand">444Music</div>

  <div class="menu">
    <button id="menuBtn">â˜°</button>
    <ul id="menuList">
      <li onclick="location.href='pricing.html'">Create New Release</li>
      <li onclick="location.href='earnings.html'">Royalties</li>
      <li onclick="location.href='home.html'">Home</li>
      <li onclick="location.href='support.html'">Support/Help</li>
      <li onclick="location.href='playlist.html'">Pitch Playlist</li>
    </ul>
  </div>
</div>

<div class="notice">
  <div class="notice-content">
    <p>
      <strong>NB:</strong> All submitted releases will remain in
      <span class="pending-text">Pending</span> status until payment is made.
      Your music will only be reviewed and distributed after payment is confirmed.
    </p>

    <a class="pay-btn" href="https://444music-distribution.vercel.app/pay.html" target="_blank">
      PAY NOW
    </a>
  </div>
</div>

<div class="header">
  <h1>My Releases</h1>
</div>

<div class="container" id="submissionsContainer"></div>

<script>
const menuBtn = document.getElementById("menuBtn");
const menuList = document.getElementById("menuList");

menuBtn.onclick = () => {
  menuList.style.display =
    menuList.style.display === "block" ? "none" : "block";
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  getDocs,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzUD7avh7vJfeSMRl2o9F09_qd-pl0dSg",
  authDomain: "usersubmissionsportal.firebaseapp.com",
  projectId: "usersubmissionsportal",
  storageBucket: "usersubmissionsportal.firebasestorage.app",
  messagingSenderId: "734783502459",
  appId: "1:734783502459:web:cfa2cc5de6976003b24ade"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const container = document.getElementById("submissionsContainer");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  const name = user.displayName || user.email.split("@")[0];

  if (!userSnap.exists()) {
    await setDoc(userRef, {
      name: name,
      email: user.email,
      earnings: 0,
      createdAt: serverTimestamp()
    });
  }

  try {
    const q = query(
      collection(db, "submissions"),
      where("userId", "==", user.uid)
    );

    const snapshot = await getDocs(q);
    container.innerHTML = "";

    if (snapshot.empty) {
      container.innerHTML = '<div class="empty">No submissions yet</div>';
      return;
    }

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      const submissionId = docSnap.id;

      const card = document.createElement("div");
      card.className = "card";

      const releaseDate = data.releaseDate
        ? new Date(data.releaseDate).toLocaleDateString("en-GB", {
            day: "2-digit",
            month: "short",
            year: "numeric"
          })
        : "Not set";

      const imageSection = data.coverURL
        ? `<img 
            src="${data.coverURL}" 
            class="cover-image"
            data-id="${submissionId}"
            style="cursor:pointer; width:100%; height:220px; object-fit:cover;"
          >`
        : `<div 
            class="cover-placeholder cover-image"
            data-id="${submissionId}"
            style="cursor:pointer;"
          >
            CLICK TO ADD COVER ART
          </div>`;

      card.innerHTML = `
        <div class="image-wrapper">
          ${imageSection}
          <input 
            type="file" 
            accept="image/*" 
            class="cover-input" 
            data-id="${submissionId}"
            style="display:none;"
          >
        </div>

        <div class="card-body">
          <h3>${data.releaseTitle}</h3>
          <p class="artist-name">${data.artistName}</p>

          ${
            data.featuring && data.featuring.trim() !== ""
              ? `<p class="feat"><strong>Featuring:</strong> ${data.featuring}</p>`
              : ""
          }

          <p class="release-date">
            <strong>Release Date:</strong> ${releaseDate}
          </p>

          <span class="badge ${data.status.toLowerCase().replace(/\s+/g, '-')}">
            ${data.status}
          </span>
        </div>
      `;

      container.appendChild(card);
    });

    // Click to open picker
    container.addEventListener("click", (e) => {
      if (e.target.classList.contains("cover-image")) {
        const id = e.target.dataset.id;
        const input = container.querySelector(`.cover-input[data-id="${id}"]`);
        if (input) input.click();
      }
    });

    // Upload + save to Firestore
    container.addEventListener("change", async (e) => {
      if (e.target.classList.contains("cover-input")) {
        const file = e.target.files[0];
        if (!file) return;

        const id = e.target.dataset.id;
        const wrapper = e.target.closest(".image-wrapper");

        const reader = new FileReader();
        reader.onload = async function(event) {
          const base64Image = event.target.result;

          // Save to Firestore
          await updateDoc(doc(db, "submissions", id), {
            coverURL: base64Image
          });

          wrapper.innerHTML = `
            <img 
              src="${base64Image}" 
              class="cover-image"
              data-id="${id}"
              style="cursor:pointer; width:100%; height:220px; object-fit:cover;"
            >
            <input 
              type="file" 
              accept="image/*" 
              class="cover-input" 
              data-id="${id}"
              style="display:none;"
            >
          `;
        };

        reader.readAsDataURL(file);
      }
    });

  } catch (err) {
    console.error("Error fetching submissions:", err);
    container.innerHTML = '<div class="empty">Failed to load submissions</div>';
  }
});
</script>

<script>
const counters = document.querySelectorAll(".counter");
const speed = 200;

counters.forEach(counter => {
  const updateCount = () => {
    const target = +counter.getAttribute("data-target");
    const count = +counter.innerText;

    const inc = target / speed;

    if (count < target) {
      counter.innerText = Math.ceil(count + inc);
      setTimeout(updateCount, 10);
    } else {
      counter.innerText = target.toLocaleString();
    }
  };

  updateCount();
});
</script>
<script>
const observer = new IntersectionObserver(entries => {
  entries.forEach(entry => {
    if(entry.isIntersecting){
      entry.target.classList.add("show");
    }
  });
});

document.querySelectorAll("section, .price-card, .testimonial, .stat").forEach(el=>{
  observer.observe(el);
});
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBzUD7avh7vJfeSMRl2o9F09_qd-pl0dSg",
  authDomain: "usersubmissionsportal.firebaseapp.com",
  projectId: "usersubmissionsportal",
  storageBucket: "usersubmissionsportal.firebasestorage.app",
  messagingSenderId: "734783502459",
  appId: "1:734783502459:web:cfa2cc5de6976003b24ade"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const grid = document.getElementById("featuredGrid");

async function loadFeatured(){
  const snapshot = await getDocs(collection(db,"submissions"));

  snapshot.forEach(doc=>{
    const data = doc.data();

    if(!data.coverURL}">
    `;

    grid.appendChild(card);
  });
}

loadFeatured();
</script>
  
</body>
</html>

